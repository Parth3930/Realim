---
import Layout from "../layouts/Layout.astro";
import { Edit2 } from "lucide-react";
---

<Layout title="Realim | P2P Space">
	<main
		class="w-full h-screen flex items-center justify-center relative overflow-hidden bg-background text-foreground"
	>
		{/* Background Decor */}
		<div class="absolute inset-0 z-0 select-none pointer-events-none">
			<div
				class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-primary/10 rounded-full blur-[140px] animate-pulse"
			>
			</div>
			<div
				class="absolute inset-0 z-0 opacity-[0.03]"
				style={{
					backgroundImage: `linear-gradient(#fff 1px, transparent 1px), linear-gradient(90deg, #fff 1px, transparent 1px)`,
					backgroundSize: "40px 40px",
				}}
			>
			</div>
		</div>

		<div
			class="relative z-10 w-full max-w-6xl mx-auto p-6 md:p-12 grid grid-cols-1 md:grid-cols-2 gap-12 items-start"
		>
			{/* Left Col: Main Controls */}
			<div
				class="space-y-8 p-10 glass rounded-3xl border border-white/10 shadow-2xl relative order-2 md:order-1"
			>
				{/* Header */}
				<div class="space-y-4 text-center md:text-left">
					<div
						class="inline-flex items-center justify-center p-3 bg-white/5 rounded-2xl mb-2 ring-1 ring-white/10 shadow-lg"
					>
						<span class="text-4xl shadow-inner">ðŸ”®</span>
					</div>
					<div>
						<h1
							class="text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-b from-white to-white/50 tracking-tight leading-tight"
						>
							Realim
						</h1>
						<p class="text-muted-foreground text-lg mt-2">
							Ephemeral, serverless, P2P collaboration.
						</p>
					</div>
				</div>

				{/* Username Config */}
				<div class="flex flex-col md:items-start items-center gap-2">
					<label
						class="text-xs uppercase tracking-wider text-muted-foreground font-semibold"
						>Your Identity</label
					>
					<div
						class="flex items-center gap-2 bg-black/30 p-2 pl-4 rounded-xl border border-white/10 group hover:border-primary/50 transition-colors w-full max-w-xs"
					>
						<div
							class="w-2 h-2 rounded-full bg-green-500 animate-pulse"
							id="status-dot"
						>
						</div>
						<input
							id="username-input"
							type="text"
							value="Loading..."
							class="bg-transparent border-none outline-none text-sm font-medium w-full text-left group-hover:text-primary transition-colors cursor-text selection:bg-primary/30"
						/>
						<Edit2 size={14} className="opacity-50 mr-2" />
					</div>
				</div>

				<div class="grid gap-8">
					{/* Create Section */}
					<div class="space-y-4">
						<div class="flex items-center gap-2">
							<input
								id="create-password"
								type="password"
								placeholder="Optional Room Password"
								class="flex-1 h-12 rounded-xl border border-white/10 bg-black/20 px-4 text-sm focus:ring-2 focus:ring-primary outline-none transition-all placeholder:text-muted-foreground/50"
							/>
						</div>
						<button
							id="create-btn"
							class="group relative w-full inline-flex h-14 items-center justify-center overflow-hidden rounded-xl bg-white/5 px-8 font-medium text-white transition-all duration-300 hover:bg-white/10 hover:scale-[1.01] shadow-2xl border border-white/10 ring-1 ring-white/5"
						>
							<div
								class="absolute inset-0 bg-gradient-to-r from-primary/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"
							>
							</div>
							<span
								class="relative flex items-center gap-3 text-lg"
							>
								Create New Space
								<svg
									xmlns="http://www.w3.org/2000/svg"
									width="20"
									height="20"
									viewBox="0 0 24 24"
									fill="none"
									stroke="currentColor"
									stroke-width="2"
									stroke-linecap="round"
									stroke-linejoin="round"
									class="transition-transform group-hover:translate-x-1"
									><path d="M5 12h14"></path><path
										d="m12 5 7 7-7 7"></path></svg
								>
							</span>
						</button>
					</div>

					<div class="relative py-2">
						<div class="absolute inset-0 flex items-center">
							<span class="w-full border-t border-white/10"
							></span>
						</div>
						<div
							class="relative flex justify-center text-xs uppercase"
						>
							<span
								class="bg-[#161618] px-3 text-muted-foreground font-medium"
								>Or join existing</span
							>
						</div>
					</div>

					<div class="flex gap-3">
						<input
							id="join-input"
							type="text"
							placeholder="Room ID"
							class="flex h-14 w-full rounded-xl border border-white/10 bg-black/20 px-5 py-2 text-sm ring-offset-background placeholder:text-muted-foreground/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary transition-all hover:bg-black/30"
						/>
						<input
							id="join-password"
							type="password"
							placeholder="Pass?"
							class="flex h-14 w-28 rounded-xl border border-white/10 bg-black/20 px-4 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary transition-all hover:bg-black/30 placeholder:text-muted-foreground/50"
						/>
						<button
							id="join-btn"
							class="h-14 w-14 shrink-0 inline-flex items-center justify-center rounded-xl border border-white/10 bg-white/5 hover:bg-primary hover:border-primary hover:text-white transition-all shadow-lg"
						>
							<svg
								xmlns="http://www.w3.org/2000/svg"
								width="24"
								height="24"
								viewBox="0 0 24 24"
								fill="none"
								stroke="currentColor"
								stroke-width="2"
								stroke-linecap="round"
								stroke-linejoin="round"
								><path
									d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"
								></path><polyline points="10 17 15 12 10 7"
								></polyline><line x1="15" y1="12" x2="3" y2="12"
								></line></svg
							>
						</button>
					</div>
				</div>
			</div>

			{/* Right Col: Recent Spaces */}
			<div class="space-y-6 order-1 md:order-2 h-full flex flex-col">
				<div
					class="bg-black/20 p-8 rounded-3xl border border-white/5 backdrop-blur-sm shadow-2xl h-full min-h-[400px]"
				>
					<h3
						class="text-xl font-semibold mb-6 flex items-center gap-2"
					>
						<span class="w-2 h-8 bg-primary rounded-full"></span>
						Recent Spaces
					</h3>

					<div
						id="recent-rooms-container"
						class="hidden w-full h-full"
					>
						<div
							id="recent-rooms-list"
							class="grid grid-cols-1 gap-3"
						>
							{/* Populated by JS */}
						</div>
					</div>

					<div
						id="empty-state"
						class="flex flex-col items-center justify-center h-[300px] text-muted-foreground opacity-50 gap-4"
					>
						<div
							class="p-4 bg-white/5 rounded-full ring-1 ring-white/10"
						>
							<svg
								xmlns="http://www.w3.org/2000/svg"
								width="32"
								height="32"
								viewBox="0 0 24 24"
								fill="none"
								stroke="currentColor"
								stroke-width="1.5"
								stroke-linecap="round"
								stroke-linejoin="round"
								><rect
									width="18"
									height="18"
									x="3"
									y="3"
									rx="2"
									ry="2"></rect><line
									x1="3"
									x2="21"
									y1="9"
									y2="9"></line><path d="m9 16 3-3 3 3"
								></path></svg
							>
						</div>
						<p class="text-sm">No recent spaces found.</p>
					</div>
				</div>
			</div>
		</div>
	</main>
</Layout>

<script>
	import { nanoid } from "nanoid";

	const usernameInput = document.getElementById(
		"username-input",
	) as HTMLInputElement;
	const createBtn = document.getElementById("create-btn");
	const createPass = document.getElementById(
		"create-password",
	) as HTMLInputElement;
	const joinInput = document.getElementById("join-input") as HTMLInputElement;
	const joinPass = document.getElementById(
		"join-password",
	) as HTMLInputElement;
	const joinBtn = document.getElementById("join-btn");
	const recentContainer = document.getElementById("recent-rooms-container");
	const emptyState = document.getElementById("empty-state");
	const recentList = document.getElementById("recent-rooms-list");

	// Load User & Recents
	try {
		const loadingName = "Anon " + Math.floor(Math.random() * 1000);
		if (usernameInput) usernameInput.value = loadingName;

		const storageFn = localStorage.getItem("realim-storage");
		if (storageFn) {
			const parsed = JSON.parse(storageFn);
			if (parsed.state) {
				if (parsed.state.username && usernameInput) {
					usernameInput.value = parsed.state.username;
				}

				// Render Recent Rooms (Max 4)
				if (
					parsed.state.savedRooms &&
					parsed.state.savedRooms.length > 0
				) {
					recentContainer?.classList.remove("hidden");
					emptyState?.classList.add("hidden");

					parsed.state.savedRooms.slice(0, 4).forEach((room: any) => {
						const el = document.createElement("a");
						el.href = `/board/${room.id}`;
						el.className =
							"flex items-center justify-between p-4 rounded-xl bg-white/5 hover:bg-white/10 border border-white/5 hover:border-primary/50 transition-all group relative overflow-hidden";
						el.innerHTML = `
                             <div class="absolute inset-0 bg-gradient-to-r from-primary/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="flex items-center gap-4 relative z-10">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-white/10 to-transparent flex items-center justify-center text-sm font-mono opacity-60 group-hover:opacity-100 group-hover:text-primary group-hover:scale-110 transition-all ring-1 ring-white/10">
                                  ${room.id.substring(0, 2).toUpperCase()}
                                </div>
                                <div class="flex flex-col">
                                    <span class="font-bold text-white/90 group-hover:text-white tracking-wide">${room.id}</span>
                                    <span class="text-xs text-muted-foreground">Last visited ${new Date(room.lastVisited).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div class="relative z-10 p-2 bg-white/5 rounded-lg text-muted-foreground group-hover:text-primary group-hover:bg-white/10 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                            </div>
                        `;
						recentList?.appendChild(el);
					});
				}
			}
		} else {
			// Init new user
			saveUser(loadingName);
		}
	} catch (e) {
		console.error("Error reading store", e);
	}

	// Must define saveUser inside or outside? Module script scope.
	function saveUser(name: string) {
		try {
			const storageFn = localStorage.getItem("realim-storage");
			let data = storageFn
				? JSON.parse(storageFn)
				: {
						state: {
							userId: nanoid(10),
							elements: {},
							savedRooms: [],
						},
						version: 0,
					};
			data.state.username = name;
			localStorage.setItem("realim-storage", JSON.stringify(data));
		} catch (e) {
			console.error("Error saving store", e);
		}
	}

	usernameInput?.addEventListener("input", (e) => {
		saveUser((e.target as HTMLInputElement).value);
	});

	createBtn?.addEventListener("click", () => {
		const id = nanoid(10);
		const pass = createPass ? (createPass as HTMLInputElement).value : "";
		if (pass) {
			localStorage.setItem(`room_pass_${id}`, pass);
		}
		window.location.href = `/board/${id}`;
	});

	const handleJoin = () => {
		const id = joinInput
			? (joinInput as HTMLInputElement).value.trim()
			: "";
		if (!id) return;

		const pass = joinPass ? (joinPass as HTMLInputElement).value : "";
		if (pass) {
			sessionStorage.setItem(`join_pass_${id}`, pass);
		}
		window.location.href = `/board/${id}`;
	};

	joinBtn?.addEventListener("click", handleJoin);
	joinInput?.addEventListener(
		"keydown",
		(e) => e.key === "Enter" && handleJoin(),
	);
	joinPass?.addEventListener(
		"keydown",
		(e) => e.key === "Enter" && handleJoin(),
	);
</script>
